#!/usr/bin/env bash

set -o errexit -o pipefail -o noclobber -o nounset

usage="Usage: .packer [build]

	creates an AMI for the couetil.com service

Commands:
	build	creates an AMI
"

wg_server_conf="[Interface]
Address = 10.0.0.1/24
ListenPort = 51820
PrivateKey = op://couetil.com/wireguard/server/private_key

[Peer]
PublicKey = op://couetil.com/wireguard/client/public_key
AllowedIPs = 10.0.0.2/32
"

sysctl_wg_conf="net.ipv4.ip_forward = 1"

www_service="[Unit]
Description=HTTP Server for www.couetil.com
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/www -addr :%i
Restart=on-failure
RestartSec=5s

PrivateUsers=true
DynamicUser=yes

[Install]
WantedBy=multi-user.target
"

build() {
	tmpdir=$(mktemp -d)
	trap "rm -rf $tmpdir" EXIT

	path_www0_conf="$tmpdir/www0.conf"
	path_wg_conf="$tmpdir/wireguard.conf"
	path_www_bin="$tmpdir/www"
	path_www_service="$tmpdir/www@.service"

	echo "$wg_server_conf" | op inject > "$path_www0_conf"
	echo "$sysctl_wg_conf" > "$path_wg_conf"
	echo "$www_service" > "$path_www_service"

	GOARCH=arm64 GOOS=linux CGOENABLED=0 go build \
		-C "$rootdir/wwwgo" \
		-o "$path_www_bin" \
		main.go

	packer build \
		-var "path_www0_conf=$path_www0_conf" \
		-var "path_wg_conf=$path_wg_conf" \
		-var "path_www_bin=$path_www_bin" \
		-var "path_www_service=$path_www_service" \
		"$rootdir/infra/vm.pkr.hcl"
}

# validate CLI arguments

if [ "$#" -eq 0 ]; then
	echo "Error: missing command"
	echo
	echo "$usage"
	exit 1
fi

if [ -z "$(declare -F | awk '{ print $3 }' | grep "$1")" ]; then
	echo "Error: undefined command \"$1\""
	echo
	echo "$usage"
	exit 1
fi

# execute CLI instructions

"$@"
