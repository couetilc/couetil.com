#!/usr/bin/env bash
usage="Usage: .vpn [command]

	Script to manage www's wireguard settings

Commands:
	up	enable wireguard interface
	down	disable wireguard interface
"

wg_client_conf="[Interface]
PrivateKey = op://couetil.com/wireguard/client/private_key
Address = 10.0.0.2/24

[Peer]
PublicKey = op://couetil.com/wireguard/server/public_key
Endpoint = $ip_www:51820
AllowedIPs = 10.0.0.1/32
"

conf="$rootdir/.local/www0.conf"
interface="$(basename $conf | sed 's/.conf//')"

# define CLI API

up() {
	# todo: if interface is up, simply `wg-quick save $new_config` to change settings
	mkdir -p "$(dirname "$conf")"

	_umask="$(umask)"
	umask 0077
	echo "$wg_client_conf" | op inject > "$conf"
	umask $_umask

	chmod 700 "$conf"
	wg-quick up "$conf"
}

down() {
	if [ -d "$(dirname conf)" ] && [ -f "$conf" ]; then
		wg-quick down "$conf"
		rm -f "$conf"
	fi
}

is_up() {
	test=$([ -f "/var/run/wireguard/$interface.name" ])
	return $test
}

# validate CLI arguments

command="$1"

if [ -z "$command" ]; then
	echo "Error: missing command"
	echo
	echo "$usage"
	exit 1
fi

if [ -z "$(declare -F | awk '{ print $3 }' | grep "$command")" ]; then
	echo "Error: undefined command \"$command\""
	echo
	echo "$usage"
	exit 1
fi

# execute CLI instructions

"$@"
