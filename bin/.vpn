#!/usr/bin/env bash
usage="Usage: .vpn [command]

	Script to manage www's wireguard settings

Commands:
	up	enable wireguard interface
	down	disable wireguard interface
"

wg_client_conf="[Interface]
PrivateKey = op://couetil.com/wireguard/client/private_key
Address = 10.0.0.2/24

[Peer]
PublicKey = op://couetil.com/wireguard/server/public_key
Endpoint = $ip_www:51820
AllowedIPs = 10.0.0.1/32
"

# define CLI API

up() {
	mkdir -p "$rootdir/.local"
	echo "$wg_client_conf" | op inject > "$rootdir/.local/www.wg0.conf"
	wg-quick up "$rootdir/.local/www.wg0.conf"
}

down() {
	if [ -d "$rootdir/.local" ] && [ -f "$rootdir/.local/www.wg0.conf" ]; then
		wg-quick down "$rootdir/.local/www.wg0.conf"
		rm -f "$rootdir/.local/www.wg0.conf"
	fi
}

# validate CLI arguments

command="$1"

if [ -z "$command" ]; then
	echo "Error: missing command"
	echo
	echo "$usage"
	exit 1
fi

if [ -z "$(declare -F | awk '{ print $3 }' | grep "$command")" ]; then
	echo "Error: undefined command \"$command\""
	echo
	echo "$usage"
	exit 1
fi

# execute CLI instructions

"$@"
